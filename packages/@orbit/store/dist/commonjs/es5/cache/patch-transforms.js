'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _data = require('@orbit/data');

var _utils = require('@orbit/utils');

exports.default = {
    addRecord: function (cache, op) {
        var record = op.record;
        var records = cache.records(record.type);
        records.set(record.id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    replaceRecord: function (cache, op) {
        var updates = op.record;
        var records = cache.records(updates.type);
        var current = records.get(updates.id);
        var record = (0, _data.mergeRecords)(current, updates);
        records.set(record.id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    removeRecord: function (cache, op) {
        var _op$record = op.record,
            type = _op$record.type,
            id = _op$record.id;

        var records = cache.records(type);
        var result = records.get(id);
        if (result) {
            records.remove(id);
            return result;
        } else {
            return null;
        }
    },
    replaceKey: function (cache, op) {
        var _op$record2 = op.record,
            type = _op$record2.type,
            id = _op$record2.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
        } else {
            record = { type: type, id: id };
        }
        (0, _utils.deepSet)(record, ['keys', op.key], op.value);
        records.set(id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    replaceAttribute: function (cache, op) {
        var _op$record3 = op.record,
            type = _op$record3.type,
            id = _op$record3.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
        } else {
            record = { type: type, id: id };
        }
        (0, _utils.deepSet)(record, ['attributes', op.attribute], op.value);
        records.set(id, record);
        return record;
    },
    addToRelatedRecords: function (cache, op) {
        var _op$record4 = op.record,
            type = _op$record4.type,
            id = _op$record4.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
        } else {
            record = { type: type, id: id };
        }
        var relatedRecords = (0, _utils.deepGet)(record, ['relationships', op.relationship, 'data']) || [];
        relatedRecords.push(op.relatedRecord);
        (0, _utils.deepSet)(record, ['relationships', op.relationship, 'data'], relatedRecords);
        records.set(id, record);
        return record;
    },
    removeFromRelatedRecords: function (cache, op) {
        var _op$record5 = op.record,
            type = _op$record5.type,
            id = _op$record5.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
            var relatedRecords = (0, _utils.deepGet)(record, ['relationships', op.relationship, 'data']);
            if (relatedRecords) {
                relatedRecords = relatedRecords.filter(function (r) {
                    return !(0, _data.equalRecordIdentities)(r, op.relatedRecord);
                });
                if ((0, _utils.deepSet)(record, ['relationships', op.relationship, 'data'], relatedRecords)) {
                    records.set(id, record);
                }
            }
            return record;
        }
        return null;
    },
    replaceRelatedRecords: function (cache, op) {
        var _op$record6 = op.record,
            type = _op$record6.type,
            id = _op$record6.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
        } else {
            record = { type: type, id: id };
        }
        if ((0, _utils.deepSet)(record, ['relationships', op.relationship, 'data'], op.relatedRecords)) {
            records.set(id, record);
        }
        return record;
    },
    replaceRelatedRecord: function (cache, op) {
        var _op$record7 = op.record,
            type = _op$record7.type,
            id = _op$record7.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
        } else {
            record = { type: type, id: id };
        }
        if ((0, _utils.deepSet)(record, ['relationships', op.relationship, 'data'], op.relatedRecord)) {
            records.set(id, record);
        }
        return record;
    }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhY2hlL3BhdGNoLXRyYW5zZm9ybXMuanMiXSwibmFtZXMiOlsicmVjb3JkIiwib3AiLCJyZWNvcmRzIiwiY2FjaGUiLCJ1cGRhdGVzIiwiY3VycmVudCIsIm1lcmdlUmVjb3JkcyIsInJlc3VsdCIsImNsb25lIiwidHlwZSIsImlkIiwiZGVlcFNldCIsInJlbGF0ZWRSZWNvcmRzIiwiZGVlcEdldCIsImVxdWFsUmVjb3JkSWRlbnRpdGllcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFDQTs7a0JBQ2U7QUFBQSxlQUFBLFVBQUEsS0FBQSxFQUFBLEVBQUEsRUFDVTtBQUNqQixZQUFJQSxTQUFTQyxHQUFiLE1BQUE7QUFDQSxZQUFNQyxVQUFVQyxNQUFBQSxPQUFBQSxDQUFjSCxPQUE5QixJQUFnQkcsQ0FBaEI7QUFDQUQsZ0JBQUFBLEdBQUFBLENBQVlGLE9BQVpFLEVBQUFBLEVBQUFBLE1BQUFBO0FBQ0EsWUFBSUMsTUFBSixNQUFBLEVBQWtCO0FBQ2RBLGtCQUFBQSxNQUFBQSxDQUFBQSxVQUFBQSxDQUFBQSxNQUFBQTtBQUNIO0FBQ0QsZUFBQSxNQUFBO0FBUk8sS0FBQTtBQUFBLG1CQUFBLFVBQUEsS0FBQSxFQUFBLEVBQUEsRUFVYztBQUNyQixZQUFNQyxVQUFVSCxHQUFoQixNQUFBO0FBQ0EsWUFBTUMsVUFBVUMsTUFBQUEsT0FBQUEsQ0FBY0MsUUFBOUIsSUFBZ0JELENBQWhCO0FBQ0EsWUFBTUUsVUFBVUgsUUFBQUEsR0FBQUEsQ0FBWUUsUUFBNUIsRUFBZ0JGLENBQWhCO0FBQ0EsWUFBTUYsU0FBU00sd0JBQUFBLE9BQUFBLEVBQWYsT0FBZUEsQ0FBZjtBQUNBSixnQkFBQUEsR0FBQUEsQ0FBWUYsT0FBWkUsRUFBQUEsRUFBQUEsTUFBQUE7QUFDQSxZQUFJQyxNQUFKLE1BQUEsRUFBa0I7QUFDZEEsa0JBQUFBLE1BQUFBLENBQUFBLFVBQUFBLENBQUFBLE1BQUFBO0FBQ0g7QUFDRCxlQUFBLE1BQUE7QUFuQk8sS0FBQTtBQUFBLGtCQUFBLFVB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RFYsR0FBaEUsYUFBSVUsQ0FBSixFQUFtRjtBQUMvRVQsb0JBQUFBLEdBQUFBLENBQUFBLEVBQUFBLEVBQUFBLE1BQUFBO0FBQ0g7QUFDRCxlQUFBLE1BQUE7QUFDSDtBQXhIVSxDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbWVyZ2VSZWNvcmRzLCBlcXVhbFJlY29yZElkZW50aXRpZXMgfSBmcm9tICdAb3JiaXQvZGF0YSc7XG5pbXBvcnQgeyBjbG9uZSwgZGVlcEdldCwgZGVlcFNldCB9IGZyb20gJ0BvcmJpdC91dGlscyc7XG5leHBvcnQgZGVmYXVsdCB7XG4gICAgYWRkUmVjb3JkKGNhY2hlLCBvcCkge1xuICAgICAgICBsZXQgcmVjb3JkID0gb3AucmVjb3JkO1xuICAgICAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3JkcyhyZWNvcmQudHlwZSk7XG4gICAgICAgIHJlY29yZHMuc2V0KHJlY29yZC5pZCwgcmVjb3JkKTtcbiAgICAgICAgaWYgKGNhY2hlLmtleU1hcCkge1xuICAgICAgICAgICAgY2FjaGUua2V5TWFwLnB1c2hSZWNvcmQocmVjb3JkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH0sXG4gICAgcmVwbGFjZVJlY29yZChjYWNoZSwgb3ApIHtcbiAgICAgICAgY29uc3QgdXBkYXRlcyA9IG9wLnJlY29yZDtcbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModXBkYXRlcy50eXBlKTtcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHJlY29yZHMuZ2V0KHVwZGF0ZXMuaWQpO1xuICAgICAgICBjb25zdCByZWNvcmQgPSBtZXJnZVJlY29yZHMoY3VycmVudCwgdXBkYXRlcyk7XG4gICAgICAgIHJlY29yZHMuc2V0KHJlY29yZC5pZCwgcmVjb3JkKTtcbiAgICAgICAgaWYgKGNhY2hlLmtleU1hcCkge1xuICAgICAgICAgICAgY2FjaGUua2V5TWFwLnB1c2hSZWNvcmQocmVjb3JkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH0sXG4gICAgcmVtb3ZlUmVjb3JkKGNhY2hlLCBvcCkge1xuICAgICAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSBvcC5yZWNvcmQ7XG4gICAgICAgIGNvbnN0IHJlY29yZHMgPSBjYWNoZS5yZWNvcmRzKHR5cGUpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSByZWNvcmRzLmdldChpZCk7XG4gICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgIHJlY29yZHMucmVtb3ZlKGlkKTtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgcmVwbGFjZUtleShjYWNoZSwgb3ApIHtcbiAgICAgICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xuICAgICAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3Jkcyh0eXBlKTtcbiAgICAgICAgbGV0IHJlY29yZCA9IHJlY29yZHMuZ2V0KGlkKTtcbiAgICAgICAgaWYgKHJlY29yZCkge1xuICAgICAgICAgICAgcmVjb3JkID0gY2xvbmUocmVjb3JkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlY29yZCA9IHsgdHlwZSwgaWQgfTtcbiAgICAgICAgfVxuICAgICAgICBkZWVwU2V0KHJlY29yZCwgWydrZXlzJywgb3Aua2V5XSwgb3AudmFsdWUpO1xuICAgICAgICByZWNvcmRzLnNldChpZCwgcmVjb3JkKTtcbiAgICAgICAgaWYgKGNhY2hlLmtleU1hcCkge1xuICAgICAgICAgICAgY2FjaGUua2V5TWFwLnB1c2hSZWNvcmQocmVjb3JkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH0sXG4gICAgcmVwbGFjZUF0dHJpYnV0ZShjYWNoZSwgb3ApIHtcbiAgICAgICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xuICAgICAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3Jkcyh0eXBlKTtcbiAgICAgICAgbGV0IHJlY29yZCA9IHJlY29yZHMuZ2V0KGlkKTtcbiAgICAgICAgaWYgKHJlY29yZCkge1xuICAgICAgICAgICAgcmVjb3JkID0gY2xvbmUocmVjb3JkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlY29yZCA9IHsgdHlwZSwgaWQgfTtcbiAgICAgICAgfVxuICAgICAgICBkZWVwU2V0KHJlY29yZCwgWydhdHRyaWJ1dGVzJywgb3AuYXR0cmlidXRlXSwgb3AudmFsdWUpO1xuICAgICAgICByZWNvcmRzLnNldChpZCwgcmVjb3JkKTtcbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9LFxuICAgIGFkZFRvUmVsYXRlZFJlY29yZHMoY2FjaGUsIG9wKSB7XG4gICAgICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IG9wLnJlY29yZDtcbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XG4gICAgICAgIGxldCByZWNvcmQgPSByZWNvcmRzLmdldChpZCk7XG4gICAgICAgIGlmIChyZWNvcmQpIHtcbiAgICAgICAgICAgIHJlY29yZCA9IGNsb25lKHJlY29yZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWNvcmQgPSB7IHR5cGUsIGlkIH07XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmVsYXRlZFJlY29yZHMgPSBkZWVwR2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgb3AucmVsYXRpb25zaGlwLCAnZGF0YSddKSB8fCBbXTtcbiAgICAgICAgcmVsYXRlZFJlY29yZHMucHVzaChvcC5yZWxhdGVkUmVjb3JkKTtcbiAgICAgICAgZGVlcFNldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIG9wLnJlbGF0aW9uc2hpcCwgJ2RhdGEnXSwgcmVsYXRlZFJlY29yZHMpO1xuICAgICAgICByZWNvcmRzLnNldChpZCwgcmVjb3JkKTtcbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9LFxuICAgIHJlbW92ZUZyb21SZWxhdGVkUmVjb3JkcyhjYWNoZSwgb3ApIHtcbiAgICAgICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xuICAgICAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3Jkcyh0eXBlKTtcbiAgICAgICAgbGV0IHJlY29yZCA9IHJlY29yZHMuZ2V0KGlkKTtcbiAgICAgICAgaWYgKHJlY29yZCkge1xuICAgICAgICAgICAgcmVjb3JkID0gY2xvbmUocmVjb3JkKTtcbiAgICAgICAgICAgIGxldCByZWxhdGVkUmVjb3JkcyA9IGRlZXBHZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcC5yZWxhdGlvbnNoaXAsICdkYXRhJ10pO1xuICAgICAgICAgICAgaWYgKHJlbGF0ZWRSZWNvcmRzKSB7XG4gICAgICAgICAgICAgICAgcmVsYXRlZFJlY29yZHMgPSByZWxhdGVkUmVjb3Jkcy5maWx0ZXIociA9PiAhZXF1YWxSZWNvcmRJZGVudGl0aWVzKHIsIG9wLnJlbGF0ZWRSZWNvcmQpKTtcbiAgICAgICAgICAgICAgICBpZiAoZGVlcFNldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIG9wLnJlbGF0aW9uc2hpcCwgJ2RhdGEnXSwgcmVsYXRlZFJlY29yZHMpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlY29yZHMuc2V0KGlkLCByZWNvcmQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSxcbiAgICByZXBsYWNlUmVsYXRlZFJlY29yZHMoY2FjaGUsIG9wKSB7XG4gICAgICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IG9wLnJlY29yZDtcbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XG4gICAgICAgIGxldCByZWNvcmQgPSByZWNvcmRzLmdldChpZCk7XG4gICAgICAgIGlmIChyZWNvcmQpIHtcbiAgICAgICAgICAgIHJlY29yZCA9IGNsb25lKHJlY29yZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWNvcmQgPSB7IHR5cGUsIGlkIH07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRlZXBTZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcC5yZWxhdGlvbnNoaXAsICdkYXRhJ10sIG9wLnJlbGF0ZWRSZWNvcmRzKSkge1xuICAgICAgICAgICAgcmVjb3Jkcy5zZXQoaWQsIHJlY29yZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9LFxuICAgIHJlcGxhY2VSZWxhdGVkUmVjb3JkKGNhY2hlLCBvcCkge1xuICAgICAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSBvcC5yZWNvcmQ7XG4gICAgICAgIGNvbnN0IHJlY29yZHMgPSBjYWNoZS5yZWNvcmRzKHR5cGUpO1xuICAgICAgICBsZXQgcmVjb3JkID0gcmVjb3Jkcy5nZXQoaWQpO1xuICAgICAgICBpZiAocmVjb3JkKSB7XG4gICAgICAgICAgICByZWNvcmQgPSBjbG9uZShyZWNvcmQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVjb3JkID0geyB0eXBlLCBpZCB9O1xuICAgICAgICB9XG4gICAgICAgIGlmIChkZWVwU2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgb3AucmVsYXRpb25zaGlwLCAnZGF0YSddLCBvcC5yZWxhdGVkUmVjb3JkKSkge1xuICAgICAgICAgICAgcmVjb3Jkcy5zZXQoaWQsIHJlY29yZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9XG59OyJdfQ==