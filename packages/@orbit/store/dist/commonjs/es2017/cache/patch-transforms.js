'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});

var _data = require('@orbit/data');

var _utils = require('@orbit/utils');

exports.default = {
    addRecord(cache, op) {
        let record = op.record;
        const records = cache.records(record.type);
        records.set(record.id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    replaceRecord(cache, op) {
        const updates = op.record;
        const records = cache.records(updates.type);
        const current = records.get(updates.id);
        const record = (0, _data.mergeRecords)(current, updates);
        records.set(record.id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    removeRecord(cache, op) {
        const { type, id } = op.record;
        const records = cache.records(type);
        const result = records.get(id);
        if (result) {
            records.remove(id);
            return result;
        } else {
            return null;
        }
    },
    replaceKey(cache, op) {
        const { type, id } = op.record;
        const records = cache.records(type);
        let record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
        } else {
            record = { type, id };
        }
        (0, _utils.deepSet)(record, ['keys', op.key], op.value);
        records.set(id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    replaceAttribute(cache, op) {
        const { type, id } = op.record;
        const records = cache.records(type);
        let record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
        } else {
            record = { type, id };
        }
        (0, _utils.deepSet)(record, ['attributes', op.attribute], op.value);
        records.set(id, record);
        return record;
    },
    addToRelatedRecords(cache, op) {
        const { type, id } = op.record;
        const records = cache.records(type);
        let record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
        } else {
            record = { type, id };
        }
        const relatedRecords = (0, _utils.deepGet)(record, ['relationships', op.relationship, 'data']) || [];
        relatedRecords.push(op.relatedRecord);
        (0, _utils.deepSet)(record, ['relationships', op.relationship, 'data'], relatedRecords);
        records.set(id, record);
        return record;
    },
    removeFromRelatedRecords(cache, op) {
        const { type, id } = op.record;
        const records = cache.records(type);
        let record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
            let relatedRecords = (0, _utils.deepGet)(record, ['relationships', op.relationship, 'data']);
            if (relatedRecords) {
                relatedRecords = relatedRecords.filter(r => !(0, _data.equalRecordIdentities)(r, op.relatedRecord));
                if ((0, _utils.deepSet)(record, ['relationships', op.relationship, 'data'], relatedRecords)) {
                    records.set(id, record);
                }
            }
            return record;
        }
        return null;
    },
    replaceRelatedRecords(cache, op) {
        const { type, id } = op.record;
        const records = cache.records(type);
        let record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
        } else {
            record = { type, id };
        }
        if ((0, _utils.deepSet)(record, ['relationships', op.relationship, 'data'], op.relatedRecords)) {
            records.set(id, record);
        }
        return record;
    },
    replaceRelatedRecord(cache, op) {
        const { type, id } = op.record;
        const records = cache.records(type);
        let record = records.get(id);
        if (record) {
            record = (0, _utils.clone)(record);
        } else {
            record = { type, id };
        }
        if ((0, _utils.deepSet)(record, ['relationships', op.relationship, 'data'], op.relatedRecord)) {
            records.set(id, record);
        }
        return record;
    }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhY2hlL3BhdGNoLXRyYW5zZm9ybXMuanMiXSwibmFtZXMiOlsiYWRkUmVjb3JkIiwiY2FjaGUiLCJvcCIsInJlY29yZCIsInJlY29yZHMiLCJ0eXBlIiwic2V0IiwiaWQiLCJrZXlNYXAiLCJwdXNoUmVjb3JkIiwicmVwbGFjZVJlY29yZCIsInVwZGF0ZXMiLCJjdXJyZW50IiwiZ2V0IiwicmVtb3ZlUmVjb3JkIiwicmVzdWx0IiwicmVtb3ZlIiwicmVwbGFjZUtleSIsImtleSIsInZhbHVlIiwicmVwbGFjZUF0dHJpYnV0ZSIsImF0dHJpYnV0ZSIsImFkZFRvUmVsYXRlZFJlY29yZHMiLCJyZWxhdGVkUmVjb3JkcyIsInJlbGF0aW9uc2hpcCIsInB1c2giLCJyZWxhdGVkUmVjb3JkIiwicmVtb3ZlRnJvbVJlbGF0ZWRSZWNvcmRzIiwiZmlsdGVyIiwiciIsInJlcGxhY2VSZWxhdGVkUmVjb3JkcyIsInJlcGxhY2VSZWxhdGVkUmVjb3JkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFDQTs7a0JBQ2U7QUFDWEEsY0FBVUMsS0FBVixFQUFpQkMsRUFBakIsRUFBcUI7QUFDakIsWUFBSUMsU0FBU0QsR0FBR0MsTUFBaEI7QUFDQSxjQUFNQyxVQUFVSCxNQUFNRyxPQUFOLENBQWNELE9BQU9FLElBQXJCLENBQWhCO0FBQ0FELGdCQUFRRSxHQUFSLENBQVlILE9BQU9JLEVBQW5CLEVBQXVCSixNQUF2QjtBQUNBLFlBQUlGLE1BQU1PLE1BQVYsRUFBa0I7QUFDZFAsa0JBQU1PLE1BQU4sQ0FBYUMsVUFBYixDQUF3Qk4sTUFBeEI7QUFDSDtBQUNELGVBQU9BLE1BQVA7QUFDSCxLQVRVO0FBVVhPLGtCQUFjVCxLQUFkLEVBQXFCQyxFQUFyQixFQUF5QjtBQUNyQixjQUFNUyxVQUFVVCxHQUFHQyxNQUFuQjtBQUNBLGNBQU1DLFVBQVVILE1BQU1HLE9BQU4sQ0FBY08sUUFBUU4sSUFBdEIsQ0FBaEI7QUFDQSxjQUFNTyxVQUFVUixRQUFRUyxHQUFSLENBQVlGLFFBQVFKLEVBQXBCLENBQWhCO0FBQ0EsY0FBTUosU0FBUyx3QkFBYVMsT0FBYixFQUFzQkQsT0FBdEIsQ0FBZjtBQUNBUCxnQkFBUUUsR0FBUixDQUFZSCxPQUFPSSxFQUFuQixFQUF1QkosTUFBdkI7QUFDQSxZQUFJRixNQUFNTyxNQUFWLEVBQWtCO0FBQ2RQLGtCQUFNTyxNQUFOLENBQWFDLFVBQWIsQ0FBd0JOLE1BQXhCO0FBQ0g7QUFDRCxlQUFPQSxNQUFQO0FBQ0gsS0FwQlU7QUFxQlhXLGlCQUFhYixLQUFiLEVBQW9CQyxFQUFwQixFQUF3QjtBQUNwQixjQUFNLEVBQUVHLElBQUYsRUFBUUUsRUFBUixLQUFlTCxHQUFHQyxNQUF4QjtBQUNBLGNBQU1DLFVBQVVILE1BQU1HLE9BQU4sQ0FBY0MsSUFBZCxDQUFoQjtBQUNBLGNBQU1VLFNBQVNYLFFBQVFTLEdBQVIsQ0FBWU4sRUFBWixDQUFmO0FBQ0EsWUFBSVEsTUFBSixFQUFZO0FBQ1JYLG9CQUFRWSxNQUFSLENBQWVULEVBQWY7QUFDQSxtQkFBT1EsTUFBUDtBQUNILFNBSEQsTUFHTztBQUNILG1CQUFPLElBQVA7QUFDSDtBQUNKLEtBL0JVO0FBZ0NYRSxlQUFXaEIsS0FBWCxFQUFrQkMsRUFBbEIsRUFBc0I7QUFDbEIsY0FBTSxFQUFFRyxJQUFGLEVBQVFFLEVBQVIsS0FBZUwsR0FBR0MsTUFBeEI7QUFDQSxjQUFNQyxVQUFVSCxNQUFNRyxPQUFOLENBQWNDLElBQWQsQ0FBaEI7QUFDQSxZQUFJRixTQUFTQyxRQUFRUyxHQUFSLENBQVlOLEVBQVosQ0FBYjtBQUNBLFlBQUlKLE1BQUosRUFBWTtBQUNSQSxxQkFBUyxrQkFBTUEsTUFBTixDQUFUO0FBQ0gsU0FGRCxNQUVPO0FBQ0hBLHFCQUFTLEVBQUVFLElBQUYsRUFBUUUsRUFBUixFQUFUO0FBQ0g7QUFDRCw0QkFBUUosTUFBUixFQUFnQixDQUFDLE1BQUQsRUFBU0QsR0FBR2dCLEdBQVosQ0FBaEIsRUFBa0NoQixHQUFHaUIsS0FBckM7QUFDQWYsZ0JBQVFFLEdBQVIsQ0FBWUMsRUFBWixFQUFnQkosTUFBaEI7QUFDQSxZQUFJRixNQUFNTyxNQUFWLEVBQWtCO0FBQ2RQLGtCQUFNTyxNQUFOLENBQWFDLFVBQWIsQ0FBd0JOLE1BQXhCO0FBQ0g7QUFDRCxlQUFPQSxNQUFQO0FBQ0gsS0EvQ1U7QUFnRFhpQixxQkFBaUJuQixLQUFqQixFQUF3QkMsRUFBeEIsRUFBNEI7QUFDeEIsY0FBTSxFQUFFRyxJQUFGLEVBQVFFLEVBQVIsS0FBZUwsR0FBR0MsTUFBeEI7QUFDQSxjQUFNQyxVQUFVSCxNQUFNRyxPQUFOLENBQWNDLElBQWQsQ0FBaEI7QUFDQSxZQUFJRixTQUFTQyxRQUFRUyxHQUFSLENBQVlOLEVBQVosQ0FBYjtBQUNBLFlBQUlKLE1BQUosRUFBWTtBQUNSQSxxQkFBUyxrQkFBTUEsTUFBTixDQUFUO0FBQ0gsU0FGRCxNQUVPO0FBQ0hBLHFCQUFTLEVBQUVFLElBQUYsRUFBUUUsRUFBUixFQUFUO0FBQ0g7QUFDRCw0QkFBUUosTUFBUixFQUFnQixDQUFDLFlBQUQsRUFBZUQsR0FBR21CLFNBQWxCLENBQWhCLEVBQThDbkIsR0FBR2lCLEtBQWpEO0FBQ0FmLGdCQUFRRSxHQUFSLENBQVlDLEVBQVosRUFBZ0JKLE1BQWhCO0FBQ0EsZUFBT0EsTUFBUDtBQUNILEtBNURVO0FBNkRYbUIsd0JBQW9CckIsS0FBcEIsRUFBMkJDLEVBQTNCLEVBQStCO0FBQzNCLGNBQU0sRUFBRUcsSUFBRixFQUFRRSxFQUFSLEtBQWVMLEdBQUdDLE1BQXhCO0FBQ0EsY0FBTUMsVUFBVUgsTUFBTUcsT0FBTixDQUFjQyxJQUFkLENBQWhCO0FBQ0EsWUFBSUYsU0FBU0MsUUFBUVMsR0FBUixDQUFZTixFQUFaLENBQWI7QUFDQSxZQUFJSixNQUFKLEVBQVk7QUFDUkEscUJBQVMsa0JBQU1BLE1BQU4sQ0FBVDtBQUNILFNBRkQsTUFFTztBQUNIQSxxQkFBUyxFQUFFRSxJQUFGLEVBQVFFLEVBQVIsRUFBVDtBQUNIO0FBQ0QsY0FBTWdCLGlCQUFpQixvQkFBUXBCLE1BQVIsRUFBZ0IsQ0FBQyxlQUFELEVBQWtCRCxHQUFHc0IsWUFBckIsRUFBbUMsTUFBbkMsQ0FBaEIsS0FBK0QsRUFBdEY7QUFDQUQsdUJBQWVFLElBQWYsQ0FBb0J2QixHQUFHd0IsYUFBdkI7QUFDQSw0QkFBUXZCLE1BQVIsRUFBZ0IsQ0FBQyxlQUFELEVBQWtCRCxHQUFHc0IsWUFBckIsRUFBbUMsTUFBbkMsQ0FBaEIsRUFBNERELGNBQTVEO0FBQ0FuQixnQkFBUUUsR0FBUixDQUFZQyxFQUFaLEVBQWdCSixNQUFoQjtBQUNBLGVBQU9BLE1BQVA7QUFDSCxLQTNFVTtBQTRFWHdCLDZCQUF5QjFCLEtBQXpCLEVBQWdDQyxFQUFoQyxFQUFvQztBQUNoQyxjQUFNLEVBQUVHLElBQUYsRUFBUUUsRUFBUixLQUFlTCxHQUFHQyxNQUF4QjtBQUNBLGNBQU1DLFVBQVVILE1BQU1HLE9BQU4sQ0FBY0MsSUFBZCxDQUFoQjtBQUNBLFlBQUlGLFNBQVNDLFFBQVFTLEdBQVIsQ0FBWU4sRUFBWixDQUFiO0FBQ0EsWUFBSUosTUFBSixFQUFZO0FBQ1JBLHFCQUFTLGtCQUFNQSxNQUFOLENBQVQ7QUFDQSxnQkFBSW9CLGlCQUFpQixvQkFBUXBCLE1BQVIsRUFBZ0IsQ0FBQyxlQUFELEVBQWtCRCxHQUFHc0IsWUFBckIsRUFBbUMsTUFBbkMsQ0FBaEIsQ0FBckI7QUFDQSxnQkFBSUQsY0FBSixFQUFvQjtBQUNoQkEsaUNBQWlCQSxlQUFlSyxNQUFmLENBQXNCQyxLQUFLLENBQUMsaUNBQXNCQSxDQUF0QixFQUF5QjNCLEdBQUd3QixhQUE1QixDQUE1QixDQUFqQjtBQUNBLG9CQUFJLG9CQUFRdkIsTUFBUixFQUFnQixDQUFDLGVBQUQsRUFBa0JELEdBQUdzQixZQUFyQixFQUFtQyxNQUFuQyxDQUFoQixFQUE0REQsY0FBNUQsQ0FBSixFQUFpRjtBQUM3RW5CLDRCQUFRRSxHQUFSLENBQVlDLEVBQVosRUFBZ0JKLE1BQWhCO0FBQ0g7QUFDSjtBQUNELG1CQUFPQSxNQUFQO0FBQ0g7QUFDRCxlQUFPLElBQVA7QUFDSCxLQTVGVTtBQTZGWDJCLDBCQUFzQjdCLEtBQXRCLEVBQTZCQyxFQUE3QixFQUFpQztBQUM3QixjQUFNLEVBQUVHLElBQUYsRUFBUUUsRUFBUixLQUFlTCxHQUFHQyxNQUF4QjtBQUNBLGNBQU1DLFVBQVVILE1BQU1HLE9BQU4sQ0FBY0MsSUFBZCxDQUFoQjtBQUNBLFlBQUlGLFNBQVNDLFFBQVFTLEdBQVIsQ0FBWU4sRUFBWixDQUFiO0FBQ0EsWUFBSUosTUFBSixFQUFZO0FBQ1JBLHFCQUFTLGtCQUFNQSxNQUFOLENBQVQ7QUFDSCxTQUZELE1BRU87QUFDSEEscUJBQVMsRUFBRUUsSUFBRixFQUFRRSxFQUFSLEVBQVQ7QUFDSDtBQUNELFlBQUksb0JBQVFKLE1BQVIsRUFBZ0IsQ0FBQyxlQUFELEVBQWtCRCxHQUFHc0IsWUFBckIsRUFBbUMsTUFBbkMsQ0FBaEIsRUFBNER0QixHQUFHcUIsY0FBL0QsQ0FBSixFQUFvRjtBQUNoRm5CLG9CQUFRRSxHQUFSLENBQVlDLEVBQVosRUFBZ0JKLE1BQWhCO0FBQ0g7QUFDRCxlQUFPQSxNQUFQO0FBQ0gsS0ExR1U7QUEyR1g0Qix5QkFBcUI5QixLQUFyQixFQUE0QkMsRUFBNUIsRUFBZ0M7QUFDNUIsY0FBTSxFQUFFRyxJQUFGLEVBQVFFLEVBQVIsS0FBZUwsR0FBR0MsTUFBeEI7QUFDQSxjQUFNQyxVQUFVSCxNQUFNRyxPQUFOLENBQWNDLElBQWQsQ0FBaEI7QUFDQSxZQUFJRixTQUFTQyxRQUFRUyxHQUFSLENBQVlOLEVBQVosQ0FBYjtBQUNBLFlBQUlKLE1BQUosRUFBWTtBQUNSQSxxQkFBUyxrQkFBTUEsTUFBTixDQUFUO0FBQ0gsU0FGRCxNQUVPO0FBQ0hBLHFCQUFTLEVBQUVFLElBQUYsRUFBUUUsRUFBUixFQUFUO0FBQ0g7QUFDRCxZQUFJLG9CQUFRSixNQUFSLEVBQWdCLENBQUMsZUFBRCxFQUFrQkQsR0FBR3NCLFlBQXJCLEVBQW1DLE1BQW5DLENBQWhCLEVBQTREdEIsR0FBR3dCLGFBQS9ELENBQUosRUFBbUY7QUFDL0V0QixvQkFBUUUsR0FBUixDQUFZQyxFQUFaLEVBQWdCSixNQUFoQjtBQUNIO0FBQ0QsZUFBT0EsTUFBUDtBQUNIO0FBeEhVLEMiLCJmaWxlIjoiY2FjaGUvcGF0Y2gtdHJhbnNmb3Jtcy5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1lcmdlUmVjb3JkcywgZXF1YWxSZWNvcmRJZGVudGl0aWVzIH0gZnJvbSAnQG9yYml0L2RhdGEnO1xuaW1wb3J0IHsgY2xvbmUsIGRlZXBHZXQsIGRlZXBTZXQgfSBmcm9tICdAb3JiaXQvdXRpbHMnO1xuZXhwb3J0IGRlZmF1bHQge1xuICAgIGFkZFJlY29yZChjYWNoZSwgb3ApIHtcbiAgICAgICAgbGV0IHJlY29yZCA9IG9wLnJlY29yZDtcbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHMocmVjb3JkLnR5cGUpO1xuICAgICAgICByZWNvcmRzLnNldChyZWNvcmQuaWQsIHJlY29yZCk7XG4gICAgICAgIGlmIChjYWNoZS5rZXlNYXApIHtcbiAgICAgICAgICAgIGNhY2hlLmtleU1hcC5wdXNoUmVjb3JkKHJlY29yZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9LFxuICAgIHJlcGxhY2VSZWNvcmQoY2FjaGUsIG9wKSB7XG4gICAgICAgIGNvbnN0IHVwZGF0ZXMgPSBvcC5yZWNvcmQ7XG4gICAgICAgIGNvbnN0IHJlY29yZHMgPSBjYWNoZS5yZWNvcmRzKHVwZGF0ZXMudHlwZSk7XG4gICAgICAgIGNvbnN0IGN1cnJlbnQgPSByZWNvcmRzLmdldCh1cGRhdGVzLmlkKTtcbiAgICAgICAgY29uc3QgcmVjb3JkID0gbWVyZ2VSZWNvcmRzKGN1cnJlbnQsIHVwZGF0ZXMpO1xuICAgICAgICByZWNvcmRzLnNldChyZWNvcmQuaWQsIHJlY29yZCk7XG4gICAgICAgIGlmIChjYWNoZS5rZXlNYXApIHtcbiAgICAgICAgICAgIGNhY2hlLmtleU1hcC5wdXNoUmVjb3JkKHJlY29yZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9LFxuICAgIHJlbW92ZVJlY29yZChjYWNoZSwgb3ApIHtcbiAgICAgICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xuICAgICAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3Jkcyh0eXBlKTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gcmVjb3Jkcy5nZXQoaWQpO1xuICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICByZWNvcmRzLnJlbW92ZShpZCk7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIHJlcGxhY2VLZXkoY2FjaGUsIG9wKSB7XG4gICAgICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IG9wLnJlY29yZDtcbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XG4gICAgICAgIGxldCByZWNvcmQgPSByZWNvcmRzLmdldChpZCk7XG4gICAgICAgIGlmIChyZWNvcmQpIHtcbiAgICAgICAgICAgIHJlY29yZCA9IGNsb25lKHJlY29yZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWNvcmQgPSB7IHR5cGUsIGlkIH07XG4gICAgICAgIH1cbiAgICAgICAgZGVlcFNldChyZWNvcmQsIFsna2V5cycsIG9wLmtleV0sIG9wLnZhbHVlKTtcbiAgICAgICAgcmVjb3Jkcy5zZXQoaWQsIHJlY29yZCk7XG4gICAgICAgIGlmIChjYWNoZS5rZXlNYXApIHtcbiAgICAgICAgICAgIGNhY2hlLmtleU1hcC5wdXNoUmVjb3JkKHJlY29yZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9LFxuICAgIHJlcGxhY2VBdHRyaWJ1dGUoY2FjaGUsIG9wKSB7XG4gICAgICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IG9wLnJlY29yZDtcbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XG4gICAgICAgIGxldCByZWNvcmQgPSByZWNvcmRzLmdldChpZCk7XG4gICAgICAgIGlmIChyZWNvcmQpIHtcbiAgICAgICAgICAgIHJlY29yZCA9IGNsb25lKHJlY29yZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWNvcmQgPSB7IHR5cGUsIGlkIH07XG4gICAgICAgIH1cbiAgICAgICAgZGVlcFNldChyZWNvcmQsIFsnYXR0cmlidXRlcycsIG9wLmF0dHJpYnV0ZV0sIG9wLnZhbHVlKTtcbiAgICAgICAgcmVjb3Jkcy5zZXQoaWQsIHJlY29yZCk7XG4gICAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgfSxcbiAgICBhZGRUb1JlbGF0ZWRSZWNvcmRzKGNhY2hlLCBvcCkge1xuICAgICAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSBvcC5yZWNvcmQ7XG4gICAgICAgIGNvbnN0IHJlY29yZHMgPSBjYWNoZS5yZWNvcmRzKHR5cGUpO1xuICAgICAgICBsZXQgcmVjb3JkID0gcmVjb3Jkcy5nZXQoaWQpO1xuICAgICAgICBpZiAocmVjb3JkKSB7XG4gICAgICAgICAgICByZWNvcmQgPSBjbG9uZShyZWNvcmQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVjb3JkID0geyB0eXBlLCBpZCB9O1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHJlbGF0ZWRSZWNvcmRzID0gZGVlcEdldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIG9wLnJlbGF0aW9uc2hpcCwgJ2RhdGEnXSkgfHwgW107XG4gICAgICAgIHJlbGF0ZWRSZWNvcmRzLnB1c2gob3AucmVsYXRlZFJlY29yZCk7XG4gICAgICAgIGRlZXBTZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcC5yZWxhdGlvbnNoaXAsICdkYXRhJ10sIHJlbGF0ZWRSZWNvcmRzKTtcbiAgICAgICAgcmVjb3Jkcy5zZXQoaWQsIHJlY29yZCk7XG4gICAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgfSxcbiAgICByZW1vdmVGcm9tUmVsYXRlZFJlY29yZHMoY2FjaGUsIG9wKSB7XG4gICAgICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IG9wLnJlY29yZDtcbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XG4gICAgICAgIGxldCByZWNvcmQgPSByZWNvcmRzLmdldChpZCk7XG4gICAgICAgIGlmIChyZWNvcmQpIHtcbiAgICAgICAgICAgIHJlY29yZCA9IGNsb25lKHJlY29yZCk7XG4gICAgICAgICAgICBsZXQgcmVsYXRlZFJlY29yZHMgPSBkZWVwR2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgb3AucmVsYXRpb25zaGlwLCAnZGF0YSddKTtcbiAgICAgICAgICAgIGlmIChyZWxhdGVkUmVjb3Jkcykge1xuICAgICAgICAgICAgICAgIHJlbGF0ZWRSZWNvcmRzID0gcmVsYXRlZFJlY29yZHMuZmlsdGVyKHIgPT4gIWVxdWFsUmVjb3JkSWRlbnRpdGllcyhyLCBvcC5yZWxhdGVkUmVjb3JkKSk7XG4gICAgICAgICAgICAgICAgaWYgKGRlZXBTZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcC5yZWxhdGlvbnNoaXAsICdkYXRhJ10sIHJlbGF0ZWRSZWNvcmRzKSkge1xuICAgICAgICAgICAgICAgICAgICByZWNvcmRzLnNldChpZCwgcmVjb3JkKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH0sXG4gICAgcmVwbGFjZVJlbGF0ZWRSZWNvcmRzKGNhY2hlLCBvcCkge1xuICAgICAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSBvcC5yZWNvcmQ7XG4gICAgICAgIGNvbnN0IHJlY29yZHMgPSBjYWNoZS5yZWNvcmRzKHR5cGUpO1xuICAgICAgICBsZXQgcmVjb3JkID0gcmVjb3Jkcy5nZXQoaWQpO1xuICAgICAgICBpZiAocmVjb3JkKSB7XG4gICAgICAgICAgICByZWNvcmQgPSBjbG9uZShyZWNvcmQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVjb3JkID0geyB0eXBlLCBpZCB9O1xuICAgICAgICB9XG4gICAgICAgIGlmIChkZWVwU2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgb3AucmVsYXRpb25zaGlwLCAnZGF0YSddLCBvcC5yZWxhdGVkUmVjb3JkcykpIHtcbiAgICAgICAgICAgIHJlY29yZHMuc2V0KGlkLCByZWNvcmQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgfSxcbiAgICByZXBsYWNlUmVsYXRlZFJlY29yZChjYWNoZSwgb3ApIHtcbiAgICAgICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xuICAgICAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3Jkcyh0eXBlKTtcbiAgICAgICAgbGV0IHJlY29yZCA9IHJlY29yZHMuZ2V0KGlkKTtcbiAgICAgICAgaWYgKHJlY29yZCkge1xuICAgICAgICAgICAgcmVjb3JkID0gY2xvbmUocmVjb3JkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlY29yZCA9IHsgdHlwZSwgaWQgfTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGVlcFNldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIG9wLnJlbGF0aW9uc2hpcCwgJ2RhdGEnXSwgb3AucmVsYXRlZFJlY29yZCkpIHtcbiAgICAgICAgICAgIHJlY29yZHMuc2V0KGlkLCByZWNvcmQpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgfVxufTsiXX0=