import { mergeRecords, equalRecordIdentities } from '@orbit/data';
import { clone, deepGet, deepSet } from '@orbit/utils';
export default {
    addRecord: function (cache, op) {
        var record = op.record;
        var records = cache.records(record.type);
        records.set(record.id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    replaceRecord: function (cache, op) {
        var updates = op.record;
        var records = cache.records(updates.type);
        var current = records.get(updates.id);
        var record = mergeRecords(current, updates);
        records.set(record.id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    removeRecord: function (cache, op) {
        var _op$record = op.record,
            type = _op$record.type,
            id = _op$record.id;

        var records = cache.records(type);
        var result = records.get(id);
        if (result) {
            records.remove(id);
            return result;
        } else {
            return null;
        }
    },
    replaceKey: function (cache, op) {
        var _op$record2 = op.record,
            type = _op$record2.type,
            id = _op$record2.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = clone(record);
        } else {
            record = { type: type, id: id };
        }
        deepSet(record, ['keys', op.key], op.value);
        records.set(id, record);
        if (cache.keyMap) {
            cache.keyMap.pushRecord(record);
        }
        return record;
    },
    replaceAttribute: function (cache, op) {
        var _op$record3 = op.record,
            type = _op$record3.type,
            id = _op$record3.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = clone(record);
        } else {
            record = { type: type, id: id };
        }
        deepSet(record, ['attributes', op.attribute], op.value);
        records.set(id, record);
        return record;
    },
    addToRelatedRecords: function (cache, op) {
        var _op$record4 = op.record,
            type = _op$record4.type,
            id = _op$record4.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = clone(record);
        } else {
            record = { type: type, id: id };
        }
        var relatedRecords = deepGet(record, ['relationships', op.relationship, 'data']) || [];
        relatedRecords.push(op.relatedRecord);
        deepSet(record, ['relationships', op.relationship, 'data'], relatedRecords);
        records.set(id, record);
        return record;
    },
    removeFromRelatedRecords: function (cache, op) {
        var _op$record5 = op.record,
            type = _op$record5.type,
            id = _op$record5.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = clone(record);
            var relatedRecords = deepGet(record, ['relationships', op.relationship, 'data']);
            if (relatedRecords) {
                relatedRecords = relatedRecords.filter(function (r) {
                    return !equalRecordIdentities(r, op.relatedRecord);
                });
                if (deepSet(record, ['relationships', op.relationship, 'data'], relatedRecords)) {
                    records.set(id, record);
                }
            }
            return record;
        }
        return null;
    },
    replaceRelatedRecords: function (cache, op) {
        var _op$record6 = op.record,
            type = _op$record6.type,
            id = _op$record6.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = clone(record);
        } else {
            record = { type: type, id: id };
        }
        if (deepSet(record, ['relationships', op.relationship, 'data'], op.relatedRecords)) {
            records.set(id, record);
        }
        return record;
    },
    replaceRelatedRecord: function (cache, op) {
        var _op$record7 = op.record,
            type = _op$record7.type,
            id = _op$record7.id;

        var records = cache.records(type);
        var record = records.get(id);
        if (record) {
            record = clone(record);
        } else {
            record = { type: type, id: id };
        }
        if (deepSet(record, ['relationships', op.relationship, 'data'], op.relatedRecord)) {
            records.set(id, record);
        }
        return record;
    }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhY2hlL3BhdGNoLXRyYW5zZm9ybXMuanMiXSwibmFtZXMiOlsibWVyZ2VSZWNvcmRzIiwiZXF1YWxSZWNvcmRJZGVudGl0aWVzIiwiY2xvbmUiLCJkZWVwR2V0IiwiZGVlcFNldCIsImFkZFJlY29yZCIsImNhY2hlIiwib3AiLCJyZWNvcmQiLCJyZWNvcmRzIiwidHlwZSIsInNldCIsImlkIiwia2V5TWFwIiwicHVzaFJlY29yZCIsInJlcGxhY2VSZWNvcmQiLCJ1cGRhdGVzIiwiY3VycmVudCIsImdldCIsInJlbW92ZVJlY29yZCIsInJlc3VsdCIsInJlbW92ZSIsInJlcGxhY2VLZXkiLCJrZXkiLCJ2YWx1ZSIsInJlcGxhY2VBdHRyaWJ1dGUiLCJhdHRyaWJ1dGUiLCJhZGRUb1JlbGF0ZWRSZWNvcmRzIiwicmVsYXRlZFJlY29yZHMiLCJyZWxhdGlvbnNoaXAiLCJwdXNoIiwicmVsYXRlZFJlY29yZCIsInJlbW92ZUZyb21SZWxhdGVkUmVjb3JkcyIsImZpbHRlciIsInIiLCJyZXBsYWNlUmVsYXRlZFJlY29yZHMiLCJyZXBsYWNlUmVsYXRlZFJlY29yZCJdLCJtYXBwaW5ncyI6IkFBQUEsU0FBU0EsWUFBVCxFQUF1QkMscUJBQXZCLFFBQW9ELGFBQXBEO0FBQ0EsU0FBU0MsS0FBVCxFQUFnQkMsT0FBaEIsRUFBeUJDLE9BQXpCLFFBQXdDLGNBQXhDO0FBQ0EsZUFBZTtBQUNYQyxhQURXLFlBQ0RDLEtBREMsRUFDTUMsRUFETixFQUNVO0FBQ2pCLFlBQUlDLFNBQVNELEdBQUdDLE1BQWhCO0FBQ0EsWUFBTUMsVUFBVUgsTUFBTUcsT0FBTixDQUFjRCxPQUFPRSxJQUFyQixDQUFoQjtBQUNBRCxnQkFBUUUsR0FBUixDQUFZSCxPQUFPSSxFQUFuQixFQUF1QkosTUFBdkI7QUFDQSxZQUFJRixNQUFNTyxNQUFWLEVBQWtCO0FBQ2RQLGtCQUFNTyxNQUFOLENBQWFDLFVBQWIsQ0FBd0JOLE1BQXhCO0FBQ0g7QUFDRCxlQUFPQSxNQUFQO0FBQ0gsS0FUVTtBQVVYTyxpQkFWVyxZQVVHVCxLQVZILEVBVVVDLEVBVlYsRUFVYztBQUNyQixZQUFNUyxVQUFVVCxHQUFHQyxNQUFuQjtBQUNBLFlBQU1DLFVBQVVILE1BQU1HLE9BQU4sQ0FBY08sUUFBUU4sSUFBdEIsQ0FBaEI7QUFDQSxZQUFNTyxVQUFVUixRQUFRUyxHQUFSLENBQVlGLFFBQVFKLEVBQXBCLENBQWhCO0FBQ0EsWUFBTUosU0FBU1IsYUFBYWlCLE9BQWIsRUFBc0JELE9BQXRCLENBQWY7QUFDQVAsZ0JBQVFFLEdBQVIsQ0FBWUgsT0FBT0ksRUFBbkIsRUFBdUJKLE1BQXZCO0FBQ0EsWUFBSUYsTUFBTU8sTUFBVixFQUFrQjtBQUNkUCxrQkFBTU8sTUFBTixDQUFhQyxVQUFiLENBQXdCTixNQUF4QjtBQUNIO0FBQ0QsZUFBT0EsTUFBUDtBQUNILEtBcEJVO0FBcUJYVyxnQkFyQlcsWUFxQkViLEtBckJGLEVBcUJTQyxFQXJCVCxFQXFCYTtBQUFBLHlCQUNDQSxHQUFHQyxNQURKO0FBQUEsWUFDWkUsSUFEWSxjQUNaQSxJQURZO0FBQUEsWUFDTkUsRUFETSxjQUNOQSxFQURNOztBQUVwQixZQUFNSCxVQUFVSCxNQUFNRyxPQUFOLENBQWNDLElBQWQsQ0FBaEI7QUFDQSxZQUFNVSxTQUFTWCxRQUFRUyxHQUFSLENBQVlOLEVBQVosQ0FBZjtBQUNBLFlBQUlRLE1BQUosRUFBWTtBQUNSWCxvQkFBUVksTUFBUixDQUFlVCxFQUFmO0FBQ0EsbUJBQU9RLE1BQVA7QUFDSCxTQUhELE1BR087QUFDSCxtQkFBTyxJQUFQO0FBQ0g7QUFDSixLQS9CVTtBQWdDWEUsY0FoQ1csWUFnQ0FoQixLQWhDQSxFQWdDT0MsRUFoQ1AsRUFnQ1c7QUFBQSwwQkFDR0EsR0FBR0MsTUFETjtBQUFBLFlBQ1ZFLElBRFUsZUFDVkEsSUFEVTtBQUFBLFlBQ0pFLEVBREksZUFDSkEsRUFESTs7QUFFbEIsWUFBTUgsVUFBVUgsTUFBTUcsT0FBTixDQUFjQyxJQUFkLENBQWhCO0FBQ0EsWUFBSUYsU0FBU0MsUUFBUVMsR0FBUixDQUFZTixFQUFaLENBQWI7QUFDQSxZQUFJSixNQUFKLEVBQVk7QUFDUkEscUJBQVNOLE1BQU1NLE1BQU4sQ0FBVDtBQUNILFNBRkQsTUFFTztBQUNIQSxxQkFBUyxFQUFFRSxVQUFGLEVBQVFFLE1BQVIsRUFBVDtBQUNIO0FBQ0RSLGdCQUFRSSxNQUFSLEVBQWdCLENBQUMsTUFBRCxFQUFTRCxHQUFHZ0IsR0FBWixDQUFoQixFQUFrQ2hCLEdBQUdpQixLQUFyQztBQUNBZixnQkFBUUUsR0FBUixDQUFZQyxFQUFaLEVBQWdCSixNQUFoQjtBQUNBLFlBQUlGLE1BQU1PLE1BQVYsRUFBa0I7QUFDZFAsa0JBQU1PLE1BQU4sQ0FBYUMsVUFBYixDQUF3Qk4sTUFBeEI7QUFDSDtBQUNELGVBQU9BLE1BQVA7QUFDSCxLQS9DVTtBQWdEWGlCLG9CQWhEVyxZQWdETW5CLEtBaEROLEVBZ0RhQyxFQWhEYixFQWdEaUI7QUFBQSwwQkFDSEEsR0FBR0MsTUFEQTtBQUFBLFlBQ2hCRSxJQURnQixlQUNoQkEsSUFEZ0I7QUFBQSxZQUNWRSxFQURVLGVBQ1ZBLEVBRFU7O0FBRXhCLFlBQU1ILFVBQVVILE1BQU1HLE9BQU4sQ0FBY0MsSUFBZCxDQUFoQjtBQUNBLFlBQUlGLFNBQVNDLFFBQVFTLEdBQVIsQ0FBWU4sRUFBWixDQUFiO0FBQ0EsWUFBSUosTUFBSixFQUFZO0FBQ1JBLHFCQUFTTixNQUFNTSxNQUFOLENBQVQ7QUFDSCxTQUZELE1BRU87QUFDSEEscUJBQVMsRUFBRUUsVUFBRixFQUFRRSxNQUFSLEVBQVQ7QUFDSDtBQUNEUixnQkFBUUksTUFBUixFQUFnQixDQUFDLFlBQUQsRUFBZUQsR0FBR21CLFNBQWxCLENBQWhCLEVBQThDbkIsR0FBR2lCLEtBQWpEO0FBQ0FmLGdCQUFRRSxHQUFSLENBQVlDLEVBQVosRUFBZ0JKLE1BQWhCO0FBQ0EsZUFBT0EsTUFBUDtBQUNILEtBNURVO0FBNkRYbUIsdUJBN0RXLFlBNkRTckIsS0E3RFQsRUE2RGdCQyxFQTdEaEIsRUE2RG9CO0FBQUEsMEJBQ05BLEdBQUdDLE1BREc7QUFBQSxZQUNuQkUsSUFEbUIsZUFDbkJBLElBRG1CO0FBQUEsWUFDYkUsRUFEYSxlQUNiQSxFQURhOztBQUUzQixZQUFNSCxVQUFVSCxNQUFNRyxPQUFOLENBQWNDLElBQWQsQ0FBaEI7QUFDQSxZQUFJRixTQUFTQyxRQUFRUyxHQUFSLENBQVlOLEVBQVosQ0FBYjtBQUNBLFlBQUlKLE1BQUosRUFBWTtBQUNSQSxxQkFBU04sTUFBTU0sTUFBTixDQUFUO0FBQ0gsU0FGRCxNQUVPO0FBQ0hBLHFCQUFTLEVBQUVFLFVBQUYsRUFBUUUsTUFBUixFQUFUO0FBQ0g7QUFDRCxZQUFNZ0IsaUJBQWlCekIsUUFBUUssTUFBUixFQUFnQixDQUFDLGVBQUQsRUFBa0JELEdBQUdzQixZQUFyQixFQUFtQyxNQUFuQyxDQUFoQixLQUErRCxFQUF0RjtBQUNBRCx1QkFBZUUsSUFBZixDQUFvQnZCLEdBQUd3QixhQUF2QjtBQUNBM0IsZ0JBQVFJLE1BQVIsRUFBZ0IsQ0FBQyxlQUFELEVBQWtCRCxHQUFHc0IsWUFBckIsRUFBbUMsTUFBbkMsQ0FBaEIsRUFBNERELGNBQTVEO0FBQ0FuQixnQkFBUUUsR0FBUixDQUFZQyxFQUFaLEVBQWdCSixNQUFoQjtBQUNBLGVBQU9BLE1BQVA7QUFDSCxLQTNFVTtBQTRFWHdCLDRCQTVFVyxZQTRFYzFCLEtBNUVkLEVBNEVxQkMsRUE1RXJCLEVBNEV5QjtBQUFBLDBCQUNYQSxHQUFHQyxNQURRO0FBQUEsWUFDeEJFLElBRHdCLGVBQ3hCQSxJQUR3QjtBQUFBLFlBQ2xCRSxFQURrQixlQUNsQkEsRUFEa0I7O0FBRWhDLFlBQU1ILFVBQVVILE1BQU1HLE9BQU4sQ0FBY0MsSUFBZCxDQUFoQjtBQUNBLFlBQUlGLFNBQVNDLFFBQVFTLEdBQVIsQ0FBWU4sRUFBWixDQUFiO0FBQ0EsWUFBSUosTUFBSixFQUFZO0FBQ1JBLHFCQUFTTixNQUFNTSxNQUFOLENBQVQ7QUFDQSxnQkFBSW9CLGlCQUFpQnpCLFFBQVFLLE1BQVIsRUFBZ0IsQ0FBQyxlQUFELEVBQWtCRCxHQUFHc0IsWUFBckIsRUFBbUMsTUFBbkMsQ0FBaEIsQ0FBckI7QUFDQSxnQkFBSUQsY0FBSixFQUFvQjtBQUNoQkEsaUNBQWlCQSxlQUFlSyxNQUFmLENBQXNCO0FBQUEsMkJBQUssQ0FBQ2hDLHNCQUFzQmlDLENBQXRCLEVBQXlCM0IsR0FBR3dCLGFBQTVCLENBQU47QUFBQSxpQkFBdEIsQ0FBakI7QUFDQSxvQkFBSTNCLFFBQVFJLE1BQVIsRUFBZ0IsQ0FBQyxlQUFELEVBQWtCRCxHQUFHc0IsWUFBckIsRUFBbUMsTUFBbkMsQ0FBaEIsRUFBNERELGNBQTVELENBQUosRUFBaUY7QUFDN0VuQiw0QkFBUUUsR0FBUixDQUFZQyxFQUFaLEVBQWdCSixNQUFoQjtBQUNIO0FBQ0o7QUFDRCxtQkFBT0EsTUFBUDtBQUNIO0FBQ0QsZUFBTyxJQUFQO0FBQ0gsS0E1RlU7QUE2RlgyQix5QkE3RlcsWUE2Rlc3QixLQTdGWCxFQTZGa0JDLEVBN0ZsQixFQTZGc0I7QUFBQSwwQkFDUkEsR0FBR0MsTUFESztBQUFBLFlBQ3JCRSxJQURxQixlQUNyQkEsSUFEcUI7QUFBQSxZQUNmRSxFQURlLGVBQ2ZBLEVBRGU7O0FBRTdCLFlBQU1ILFVBQVVILE1BQU1HLE9BQU4sQ0FBY0MsSUFBZCxDQUFoQjtBQUNBLFlBQUlGLFNBQVNDLFFBQVFTLEdBQVIsQ0FBWU4sRUFBWixDQUFiO0FBQ0EsWUFBSUosTUFBSixFQUFZO0FBQ1JBLHFCQUFTTixNQUFNTSxNQUFOLENBQVQ7QUFDSCxTQUZELE1BRU87QUFDSEEscUJBQVMsRUFBRUUsVUFBRixFQUFRRSxNQUFSLEVBQVQ7QUFDSDtBQUNELFlBQUlSLFFBQVFJLE1BQVIsRUFBZ0IsQ0FBQyxlQUFELEVBQWtCRCxHQUFHc0IsWUFBckIsRUFBbUMsTUFBbkMsQ0FBaEIsRUFBNER0QixHQUFHcUIsY0FBL0QsQ0FBSixFQUFvRjtBQUNoRm5CLG9CQUFRRSxHQUFSLENBQVlDLEVBQVosRUFBZ0JKLE1BQWhCO0FBQ0g7QUFDRCxlQUFPQSxNQUFQO0FBQ0gsS0ExR1U7QUEyR1g0Qix3QkEzR1csWUEyR1U5QixLQTNHVixFQTJHaUJDLEVBM0dqQixFQTJHcUI7QUFBQSwwQkFDUEEsR0FBR0MsTUFESTtBQUFBLFlBQ3BCRSxJQURvQixlQUNwQkEsSUFEb0I7QUFBQSxZQUNkRSxFQURjLGVBQ2RBLEVBRGM7O0FBRTVCLFlBQU1ILFVBQVVILE1BQU1HLE9BQU4sQ0FBY0MsSUFBZCxDQUFoQjtBQUNBLFlBQUlGLFNBQVNDLFFBQVFTLEdBQVIsQ0FBWU4sRUFBWixDQUFiO0FBQ0EsWUFBSUosTUFBSixFQUFZO0FBQ1JBLHFCQUFTTixNQUFNTSxNQUFOLENBQVQ7QUFDSCxTQUZELE1BRU87QUFDSEEscUJBQVMsRUFBRUUsVUFBRixFQUFRRSxNQUFSLEVBQVQ7QUFDSDtBQUNELFlBQUlSLFFBQVFJLE1BQVIsRUFBZ0IsQ0FBQyxlQUFELEVBQWtCRCxHQUFHc0IsWUFBckIsRUFBbUMsTUFBbkMsQ0FBaEIsRUFBNER0QixHQUFHd0IsYUFBL0QsQ0FBSixFQUFtRjtBQUMvRXRCLG9CQUFRRSxHQUFSLENBQVlDLEVBQVosRUFBZ0JKLE1BQWhCO0FBQ0g7QUFDRCxlQUFPQSxNQUFQO0FBQ0g7QUF4SFUsQ0FBZiIsImZpbGUiOiJjYWNoZS9wYXRjaC10cmFuc2Zvcm1zLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbWVyZ2VSZWNvcmRzLCBlcXVhbFJlY29yZElkZW50aXRpZXMgfSBmcm9tICdAb3JiaXQvZGF0YSc7XG5pbXBvcnQgeyBjbG9uZSwgZGVlcEdldCwgZGVlcFNldCB9IGZyb20gJ0BvcmJpdC91dGlscyc7XG5leHBvcnQgZGVmYXVsdCB7XG4gICAgYWRkUmVjb3JkKGNhY2hlLCBvcCkge1xuICAgICAgICBsZXQgcmVjb3JkID0gb3AucmVjb3JkO1xuICAgICAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3JkcyhyZWNvcmQudHlwZSk7XG4gICAgICAgIHJlY29yZHMuc2V0KHJlY29yZC5pZCwgcmVjb3JkKTtcbiAgICAgICAgaWYgKGNhY2hlLmtleU1hcCkge1xuICAgICAgICAgICAgY2FjaGUua2V5TWFwLnB1c2hSZWNvcmQocmVjb3JkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH0sXG4gICAgcmVwbGFjZVJlY29yZChjYWNoZSwgb3ApIHtcbiAgICAgICAgY29uc3QgdXBkYXRlcyA9IG9wLnJlY29yZDtcbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModXBkYXRlcy50eXBlKTtcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHJlY29yZHMuZ2V0KHVwZGF0ZXMuaWQpO1xuICAgICAgICBjb25zdCByZWNvcmQgPSBtZXJnZVJlY29yZHMoY3VycmVudCwgdXBkYXRlcyk7XG4gICAgICAgIHJlY29yZHMuc2V0KHJlY29yZC5pZCwgcmVjb3JkKTtcbiAgICAgICAgaWYgKGNhY2hlLmtleU1hcCkge1xuICAgICAgICAgICAgY2FjaGUua2V5TWFwLnB1c2hSZWNvcmQocmVjb3JkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH0sXG4gICAgcmVtb3ZlUmVjb3JkKGNhY2hlLCBvcCkge1xuICAgICAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSBvcC5yZWNvcmQ7XG4gICAgICAgIGNvbnN0IHJlY29yZHMgPSBjYWNoZS5yZWNvcmRzKHR5cGUpO1xuICAgICAgICBjb25zdCByZXN1bHQgPSByZWNvcmRzLmdldChpZCk7XG4gICAgICAgIGlmIChyZXN1bHQpIHtcbiAgICAgICAgICAgIHJlY29yZHMucmVtb3ZlKGlkKTtcbiAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgcmVwbGFjZUtleShjYWNoZSwgb3ApIHtcbiAgICAgICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xuICAgICAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3Jkcyh0eXBlKTtcbiAgICAgICAgbGV0IHJlY29yZCA9IHJlY29yZHMuZ2V0KGlkKTtcbiAgICAgICAgaWYgKHJlY29yZCkge1xuICAgICAgICAgICAgcmVjb3JkID0gY2xvbmUocmVjb3JkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlY29yZCA9IHsgdHlwZSwgaWQgfTtcbiAgICAgICAgfVxuICAgICAgICBkZWVwU2V0KHJlY29yZCwgWydrZXlzJywgb3Aua2V5XSwgb3AudmFsdWUpO1xuICAgICAgICByZWNvcmRzLnNldChpZCwgcmVjb3JkKTtcbiAgICAgICAgaWYgKGNhY2hlLmtleU1hcCkge1xuICAgICAgICAgICAgY2FjaGUua2V5TWFwLnB1c2hSZWNvcmQocmVjb3JkKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH0sXG4gICAgcmVwbGFjZUF0dHJpYnV0ZShjYWNoZSwgb3ApIHtcbiAgICAgICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xuICAgICAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3Jkcyh0eXBlKTtcbiAgICAgICAgbGV0IHJlY29yZCA9IHJlY29yZHMuZ2V0KGlkKTtcbiAgICAgICAgaWYgKHJlY29yZCkge1xuICAgICAgICAgICAgcmVjb3JkID0gY2xvbmUocmVjb3JkKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlY29yZCA9IHsgdHlwZSwgaWQgfTtcbiAgICAgICAgfVxuICAgICAgICBkZWVwU2V0KHJlY29yZCwgWydhdHRyaWJ1dGVzJywgb3AuYXR0cmlidXRlXSwgb3AudmFsdWUpO1xuICAgICAgICByZWNvcmRzLnNldChpZCwgcmVjb3JkKTtcbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9LFxuICAgIGFkZFRvUmVsYXRlZFJlY29yZHMoY2FjaGUsIG9wKSB7XG4gICAgICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IG9wLnJlY29yZDtcbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XG4gICAgICAgIGxldCByZWNvcmQgPSByZWNvcmRzLmdldChpZCk7XG4gICAgICAgIGlmIChyZWNvcmQpIHtcbiAgICAgICAgICAgIHJlY29yZCA9IGNsb25lKHJlY29yZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWNvcmQgPSB7IHR5cGUsIGlkIH07XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgcmVsYXRlZFJlY29yZHMgPSBkZWVwR2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgb3AucmVsYXRpb25zaGlwLCAnZGF0YSddKSB8fCBbXTtcbiAgICAgICAgcmVsYXRlZFJlY29yZHMucHVzaChvcC5yZWxhdGVkUmVjb3JkKTtcbiAgICAgICAgZGVlcFNldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIG9wLnJlbGF0aW9uc2hpcCwgJ2RhdGEnXSwgcmVsYXRlZFJlY29yZHMpO1xuICAgICAgICByZWNvcmRzLnNldChpZCwgcmVjb3JkKTtcbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9LFxuICAgIHJlbW92ZUZyb21SZWxhdGVkUmVjb3JkcyhjYWNoZSwgb3ApIHtcbiAgICAgICAgY29uc3QgeyB0eXBlLCBpZCB9ID0gb3AucmVjb3JkO1xuICAgICAgICBjb25zdCByZWNvcmRzID0gY2FjaGUucmVjb3Jkcyh0eXBlKTtcbiAgICAgICAgbGV0IHJlY29yZCA9IHJlY29yZHMuZ2V0KGlkKTtcbiAgICAgICAgaWYgKHJlY29yZCkge1xuICAgICAgICAgICAgcmVjb3JkID0gY2xvbmUocmVjb3JkKTtcbiAgICAgICAgICAgIGxldCByZWxhdGVkUmVjb3JkcyA9IGRlZXBHZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcC5yZWxhdGlvbnNoaXAsICdkYXRhJ10pO1xuICAgICAgICAgICAgaWYgKHJlbGF0ZWRSZWNvcmRzKSB7XG4gICAgICAgICAgICAgICAgcmVsYXRlZFJlY29yZHMgPSByZWxhdGVkUmVjb3Jkcy5maWx0ZXIociA9PiAhZXF1YWxSZWNvcmRJZGVudGl0aWVzKHIsIG9wLnJlbGF0ZWRSZWNvcmQpKTtcbiAgICAgICAgICAgICAgICBpZiAoZGVlcFNldChyZWNvcmQsIFsncmVsYXRpb25zaGlwcycsIG9wLnJlbGF0aW9uc2hpcCwgJ2RhdGEnXSwgcmVsYXRlZFJlY29yZHMpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlY29yZHMuc2V0KGlkLCByZWNvcmQpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSxcbiAgICByZXBsYWNlUmVsYXRlZFJlY29yZHMoY2FjaGUsIG9wKSB7XG4gICAgICAgIGNvbnN0IHsgdHlwZSwgaWQgfSA9IG9wLnJlY29yZDtcbiAgICAgICAgY29uc3QgcmVjb3JkcyA9IGNhY2hlLnJlY29yZHModHlwZSk7XG4gICAgICAgIGxldCByZWNvcmQgPSByZWNvcmRzLmdldChpZCk7XG4gICAgICAgIGlmIChyZWNvcmQpIHtcbiAgICAgICAgICAgIHJlY29yZCA9IGNsb25lKHJlY29yZCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWNvcmQgPSB7IHR5cGUsIGlkIH07XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGRlZXBTZXQocmVjb3JkLCBbJ3JlbGF0aW9uc2hpcHMnLCBvcC5yZWxhdGlvbnNoaXAsICdkYXRhJ10sIG9wLnJlbGF0ZWRSZWNvcmRzKSkge1xuICAgICAgICAgICAgcmVjb3Jkcy5zZXQoaWQsIHJlY29yZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9LFxuICAgIHJlcGxhY2VSZWxhdGVkUmVjb3JkKGNhY2hlLCBvcCkge1xuICAgICAgICBjb25zdCB7IHR5cGUsIGlkIH0gPSBvcC5yZWNvcmQ7XG4gICAgICAgIGNvbnN0IHJlY29yZHMgPSBjYWNoZS5yZWNvcmRzKHR5cGUpO1xuICAgICAgICBsZXQgcmVjb3JkID0gcmVjb3Jkcy5nZXQoaWQpO1xuICAgICAgICBpZiAocmVjb3JkKSB7XG4gICAgICAgICAgICByZWNvcmQgPSBjbG9uZShyZWNvcmQpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVjb3JkID0geyB0eXBlLCBpZCB9O1xuICAgICAgICB9XG4gICAgICAgIGlmIChkZWVwU2V0KHJlY29yZCwgWydyZWxhdGlvbnNoaXBzJywgb3AucmVsYXRpb25zaGlwLCAnZGF0YSddLCBvcC5yZWxhdGVkUmVjb3JkKSkge1xuICAgICAgICAgICAgcmVjb3Jkcy5zZXQoaWQsIHJlY29yZCk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICB9XG59OyJdfQ==